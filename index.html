<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earth Globe - ISS Tracker</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 150, 255, 0.5);
            letter-spacing: 3px;
            user-select: none;
            z-index: 100;
        }
        #canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            color: white;
            user-select: text;
        }
        #controls input {
            margin: 5px 0;
            padding: 8px;
            width: 150px;
            border-radius: 5px;
            border: none;
        }
        #controls button {
            padding: 10px 20px;
            margin-top: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #controls button:hover {
            background: #45a049;
        }
        #controls label {
            display: block;
            margin-top: 10px;
            font-size: 14px;
        }
        #currentLocation {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            user-select: text;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            display: none;
        }
        #crosshair::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: rgba(255, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #crosshairInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
            user-select: text;
        }
        #dateTimeInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            user-select: text;
        }
        #issInfo {
            position: absolute;
            top: 110px;
            right: 20px;
            background: rgba(0, 50, 100, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            user-select: text;
            min-width: 200px;
        }
        #issInfo h4 {
            margin: 0 0 10px 0;
            color: #4fc3f7;
        }
        .toggle-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: text;
        }
        .toggle-label input {
            margin-right: 10px;
            cursor: pointer;
            width: auto;
        }
    </style>
</head>
<body>
    <div id="title">üõ∞Ô∏è ISS TRACKER</div>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <h3 style="margin-top: 0;">Navigate to Coordinates</h3>
        <label>Latitude (-90 to 90):</label>
        <input type="number" id="lat" placeholder="e.g., 40.7128" step="any" min="-90" max="90">
        <label>Longitude (-180 to 180):</label>
        <input type="number" id="lon" placeholder="e.g., -74.0060" step="any" min="-180" max="180">
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">Example: New York is at 40.7128¬∞ N, 74.0060¬∞ W</p>
        <button onclick="goToCoordinates()">Go to Location</button>
        <button onclick="goToNewYork()" style="background: #2196F3; margin-top: 5px;">Go to New York</button>
        
        <div class="toggle-container">
            <label class="toggle-label">
                <input type="checkbox" id="crosshairToggle" onchange="toggleCrosshair()">
                Enable Crosshair
            </label>
        </div>
    </div>
    <div id="currentLocation">No location selected</div>
    <div id="crosshair"></div>
    <div id="dateTimeInfo"></div>
    <div id="issInfo">
        <h4>üõ∞Ô∏è ISS Position</h4>
        <div id="issData">Loading...</div>
    </div>
    <div id="crosshairInfo"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, earth, marker;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let rotation = { x: 0, y: 0 };
        let crosshairEnabled = false;
        let raycaster = new THREE.Raycaster();
        let mouseVector = new THREE.Vector2(0, 0);
        let referenceMarker;
        let issMarker;

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 3;

            // Renderer setup
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 3, 5);
            scene.add(directionalLight);

            // Create Earth
            const geometry = new THREE.SphereGeometry(1, 64, 64);
            
            // Load Earth texture (high quality 8K texture)
            const textureLoader = new THREE.TextureLoader();
            const earthTexture = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg');
            
            const material = new THREE.MeshPhongMaterial({
                map: earthTexture,
                shininess: 10
            });
            
            earth = new THREE.Mesh(geometry, material);
            // Rotate Earth so 0¬∞ longitude aligns with Greenwich, UK
            // Additional offset to align texture with real geography
            earth.rotation.y = Math.PI + 0.05;
            scene.add(earth);


            // Mouse controls
            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mousemove', onMouseMove);
            canvas.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('mouseleave', onMouseUp);

            // Touch controls
            canvas.addEventListener('touchstart', onTouchStart);
            canvas.addEventListener('touchmove', onTouchMove);
            canvas.addEventListener('touchend', onTouchEnd);

            // Wheel zoom
            canvas.addEventListener('wheel', onWheel);

            // Window resize
            window.addEventListener('resize', onWindowResize);

            // Update date and time
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Fetch and update ISS position
            updateISSPosition();
            setInterval(updateISSPosition, 5000); // Update every 5 seconds

            animate();
        }

        function onWheel(e) {
            e.preventDefault();
            
            // Zoom in/out based on wheel direction
            const zoomSpeed = 0.1;
            const delta = e.deltaY > 0 ? 1 : -1;
            
            camera.position.z += delta * zoomSpeed;
            
            // Clamp zoom to prevent going too close or too far
            camera.position.z = Math.max(1.5, Math.min(10, camera.position.z));
        }

        function onMouseDown(e) {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        }

        function onMouseMove(e) {
            if (isDragging) {
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                rotation.y += deltaX * 0.005;
                rotation.x += deltaY * 0.005;

                // Clamp vertical rotation
                rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotation.x));

                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        }

        function onMouseUp() {
            isDragging = false;
        }

        function onTouchStart(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        function onTouchMove(e) {
            if (isDragging && e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;

                rotation.y += deltaX * 0.005;
                rotation.x += deltaY * 0.005;

                rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotation.x));

                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        function onTouchEnd() {
            isDragging = false;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function latLonToVector3(lat, lon, radius) {
            // Convert lat/lon to radians
            const phi = (lat) * (Math.PI / 180);
            const theta = (lon) * (Math.PI / 180);

            // Spherical to Cartesian coordinates matching crosshair system
            const x = radius * Math.cos(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi);
            const z = -radius * Math.cos(phi) * Math.sin(theta);

            return new THREE.Vector3(x, y, z);
        }

        function goToCoordinates() {
            const lat = parseFloat(document.getElementById('lat').value);
            let lon = parseFloat(document.getElementById('lon').value);

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid coordinates');
                return;
            }

            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Latitude must be between -90 and 90, Longitude between -180 and 180');
                return;
            }

            // Calculate rotation to center on this coordinate
            rotation.y = -lon * (Math.PI / 180);
            rotation.x = lat * (Math.PI / 180);

            // Update location display with original input
            document.getElementById('currentLocation').textContent = 
                `Location: ${lat.toFixed(4)}¬∞ ${lat >= 0 ? 'N' : 'S'}, ${Math.abs(lon).toFixed(4)}¬∞ ${lon >= 0 ? 'E' : 'W'}`;
        }

        function goToNewYork() {
            // New York coordinates (standard: negative for west)
            const lat = 40.7128;
            const lon = -74.0060;

            // Rotate earth to show New York
            rotation.y = -lon * (Math.PI / 180);
            rotation.x = lat * (Math.PI / 180);

            // Update input fields
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;

            // Update location display
            document.getElementById('currentLocation').textContent = 
                `Location: New York, USA - ${lat.toFixed(4)}¬∞ N, ${Math.abs(lon).toFixed(4)}¬∞ W`;
        }

        function toggleCrosshair() {
            crosshairEnabled = document.getElementById('crosshairToggle').checked;
            document.getElementById('crosshair').style.display = crosshairEnabled ? 'block' : 'none';
            document.getElementById('crosshairInfo').style.display = crosshairEnabled ? 'block' : 'none';
            
            if (!crosshairEnabled) {
                document.getElementById('crosshairInfo').textContent = '';
            }
        }

        function vector3ToLatLon(vector) {
            // Convert 3D position to lat/lon
            const x = vector.x;
            const y = vector.y;
            const z = vector.z;
            
            const lat = Math.asin(y) * (180 / Math.PI);
            const lon = Math.atan2(-z, x) * (180 / Math.PI);
            
            return { lat, lon };
        }

        function updateCrosshairPosition() {
            if (!crosshairEnabled) return;

            // Raycast from center of screen
            raycaster.setFromCamera(mouseVector, camera);
            const intersects = raycaster.intersectObject(earth);

            if (intersects.length > 0) {
                const point = intersects[0].point;
                
                // The point is in world space with rotations applied
                // We need to get the local position on the sphere
                const localPoint = point.clone();
                
                // Convert to earth's local space by applying inverse of earth's rotation
                const earthMatrix = new THREE.Matrix4();
                earthMatrix.makeRotationFromEuler(earth.rotation);
                earthMatrix.invert();
                localPoint.applyMatrix4(earthMatrix);
                
                // Normalize to unit sphere
                localPoint.normalize();
                
                const coords = vector3ToLatLon(localPoint);
                
                document.getElementById('crosshairInfo').innerHTML = 
                    `<strong>Crosshair Location:</strong><br>` +
                    `Lat: ${coords.lat.toFixed(4)}¬∞ ${coords.lat >= 0 ? 'N' : 'S'}<br>` +
                    `Lon: ${Math.abs(coords.lon).toFixed(4)}¬∞ ${coords.lon >= 0 ? 'E' : 'W'}`;
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // Apply rotation to earth (add base rotation to align Greenwich)
            earth.rotation.y = rotation.y - (Math.PI / 2);
            earth.rotation.x = rotation.x;

            // ISS marker is now a child of Earth, so it rotates automatically

            // Reference marker stays fixed in world space - no rotation applied

            // Update crosshair coordinates
            updateCrosshairPosition();

            renderer.render(scene, camera);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            document.getElementById('dateTimeInfo').innerHTML = 
                `<strong>Current Time</strong><br>${now.toLocaleString('en-US', options)}`;
        }

        async function updateISSPosition() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();
                
                const lat = parseFloat(data.latitude);
                const lon = parseFloat(data.longitude);
                const altitude = parseFloat(data.altitude).toFixed(2);
                const velocity = parseFloat(data.velocity).toFixed(2);

                // Update ISS info display
                document.getElementById('issData').innerHTML = 
                    `<strong>Latitude:</strong> ${lat.toFixed(4)}¬∞ ${lat >= 0 ? 'N' : 'S'}<br>` +
                    `<strong>Longitude:</strong> ${Math.abs(lon).toFixed(4)}¬∞ ${lon >= 0 ? 'E' : 'W'}<br>` +
                    `<strong>Altitude:</strong> ${altitude} km<br>` +
                    `<strong>Velocity:</strong> ${velocity} km/h`;

                // Remove existing ISS marker
                if (issMarker) {
                    earth.remove(issMarker);
                }

                // Create ISS marker (cyan/blue color to distinguish from user marker)
                const issGeometry = new THREE.SphereGeometry(0.025, 16, 16);
                const issMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                issMarker = new THREE.Mesh(issGeometry, issMaterial);
                
                // Position ISS marker above Earth surface (radius 1.05 to be clearly visible)
                const localPosition = latLonToVector3(lat, lon, 1.05);
                issMarker.position.copy(localPosition);
                
                // Add ISS marker as child of Earth so it rotates with the globe
                earth.add(issMarker);

            } catch (error) {
                console.error('Error fetching ISS position:', error);
                document.getElementById('issData').innerHTML = 'Error loading ISS data';
            }
        }

        init();
    </script>
</body>
</html>